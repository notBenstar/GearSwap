function get_sets()
    sets.precast = {}
    sets.precast.JA = {}

    -- Precast Sets
    sets.precast.JA.Nightingale = {feet = "Bihu Slippers"}

    sets.precast.JA.Troubadour = {body = "Bihu Justaucorps"}

    sets.precast.JA['Soul Voice'] = {legs = "Bihu Cannions"}

    sets.precast.FC = {}

    sets.precast.FC.Song = {
        head = "Aya. Zucchetto +1",
        body = "Vrikodara Jupon",
        hands = {
            name = "Leyline Gloves",
            augments = {
                'Accuracy+12',
                'Mag. Acc.+14',
                '"Mag.Atk.Bns."+15',
                '"Fast Cast"+2',
            }
        },
        legs = "Aya. Cosciales +2",
        feet = "Aya. Gambieras +1",
        neck = "Voltsurge Torque",
        waist = "Witful Belt",
        left_ear = "Etiolation Earring",
        right_ear = "Loquac. Earring",
        left_ring = "Kishar Ring",
        right_ring = "Rahab Ring",
    }

    sets.precast.FC.Normal = {
        head = "Aya. Zucchetto +1",
        body = "Vrikodara Jupon",
        hands = {
            name = "Leyline Gloves",
            augments = {
                'Accuracy+12',
                'Mag. Acc.+14',
                '"Mag.Atk.Bns."+15',
                '"Fast Cast"+2',
            }
        },
        legs = "Aya. Cosciales +2",
        feet = "Aya. Gambieras +1",
        neck = "Voltsurge Torque",
        waist = "Witful Belt",
        left_ear = "Etiolation Earring",
        right_ear = "Loquac. Earring",
        left_ring = "Kishar Ring",
        right_ring = "Rahab Ring",
    }

    sets.precast.EnhancingMagic = {waist = "Siegel Sash"}

    sets.precast.Cure = {
        head = "Aya. Zucchetto +1",
        body = "Vrikodara Jupon",
        hands = {
            name = "Leyline Gloves",
            augments = {
                'Accuracy+12',
                'Mag. Acc.+14',
                '"Mag.Atk.Bns."+15',
                '"Fast Cast"+2',
            }
        },
        legs = "Aya. Cosciales +2",
        feet = "Aya. Gambieras +1",
        neck = "Voltsurge Torque",
        waist = "Witful Belt",
        left_ear = "Etiolation Earring",
        right_ear = "Loquac. Earring",
        left_ring = "Kishar Ring",
        right_ring = "Rahab Ring",
    }

    sets.precast.WS = {}
    sets.MordantRime = {
        head = "Brioso roundlet +3",
        body = "Brioso Justau. +3",
        hands = "Brioso cuffs +3",
        legs = "Brioso Cannions +3",
        feet = "Brioso Slippers +3",
        neck = "Fotia gorget",
        waist = "Grunfeld rope",
        left_ear = "Brutal Earring",
        right_ear = "Telos Earring",
        left_ring = "Shukuyu Ring",
        right_ring = "Ilabrat Ring",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'Accuracy+20 Attack+20',
                'Weapon skill damage +10%',
            }
        },
    }

    sets.precast.WS = {}
    sets.Rudra = {
        head = "Aya. Zucchetto +1",
        body = "Ashera Harness",
        hands = "Aya. Manopolas +1",
        legs = "Aya. Cosciales +2",
        feet = {
            name = "Lustra. Leggings +1",
            augments = {'HP+65', 'STR+15', 'DEX+15',}
        },
        neck = "Caro Necklace",
        waist = "Grunfeld Rope",
        left_ear = "Ishvara Earring",
        right_ear = {
            name = "Moonshade Earring",
            augments = {'Accuracy+4', 'TP Bonus +250',}
        },
        left_ring = "Ilabrat Ring",
        right_ring = "Petrov Ring",
        back = {
            name = "Mecisto. Mantle",
            augments = {
                'Cap. Point+48%',
                'MP+13',
                '"Mag.Atk.Bns."+3',
                'DEF+5',
            }
        },
    }

    sets.precast.WS = {}
    sets.Exen = {
        head = "Lustratio cap",
        body = "Ayanmo Corazza +1",
        hands = "Lustratio mittens",
        legs = "Lustratio subligar",
        feet = "Ayanmo Gambieras +1",
        neck = "Fotia gorget",
        waist = "Fotia belt",
        left_ear = "Brutal Earring",
        right_ear = "Telos Earring",
        left_ring = "Shukuyu Ring",
        right_ring = "Ilabrat Ring",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'Accuracy+20 Attack+20',
                'Weapon skill damage +10%',
            }
        },
    }

    sets.precast.WS = {}
    sets.Evisceration = {
        head = "Lustratio cap",
        body = "Ayanmo Corazza +1",
        hands = "Lustratio mittens",
        legs = "Jokoshu haidate",
        feet = "Ayanmo Gambieras +1",
        neck = "Fotia gorget",
        waist = "Fotia belt",
        left_ear = "Brutal Earring",
        right_ear = "Telos Earring",
        left_ring = "Shukuyu Ring",
        right_ring = "Ilabrat Ring",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'Accuracy+20 Attack+20',
                'Weapon skill damage +10%',
            }
        },
    }

    sets.TP = {
        head = "Aya. Zucchetto +1",
        body = "Ashera Harness",
        hands = "Volte Bracers",
        legs = "Aya. Cosciales +2",
        feet = "Aya. Gambieras +1",
        neck = "Lissome Necklace",
        waist = "Reiki Yotai",
        left_ear = "Telos Earring",
        right_ear = "Suppanomimi",
        left_ring = "Ilabrat Ring",
        right_ring = "Chirich Ring",
        back = {
            name = "Mecisto. Mantle",
            augments = {
                'Cap. Point+48%',
                'MP+13',
                '"Mag.Atk.Bns."+3',
                'DEF+5',
            }
        },
    }

    -- Midcast Sets
    sets.midcast = {}

    sets.midcast.Haste = {
        main = "Grioavolr",
        sub = "Fulcio grip",
        head = "Vanya Hood",
        neck = "Nodens gorget",
        ear1 = "Enchanter Earring +1",
        ear2 = "Loquac. Earring",
        body = "Inyanga jubbah +1",
        hands = "Kaykaus cuffs",
        ring1 = "Rahab Ring",
        ring2 = "kishar Ring",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
        waist = "Siegel Sash",
        legs = "Chironic hose",
        feet = "Kaykaus boots"
    }

    sets.midcast.Debuff = {
        main = "Carnwenhan",
        sub = "Genmei shield",
        range = "Gjallarhorn",
        head = "Brioso roundlet +3",
        body = "Brioso Justau. +3",
        hands = "Brioso cuffs +3",
        legs = "Brioso Cannions +3",
        feet = "Brioso Slippers +3",
        neck = "Moonbow whistle +1",
        waist = "Luminary Sash",
        left_ear = "Enchntr. Earring +1",
        right_ear = "Regal Earring",
        left_ring = "Kishar Ring",
        right_ring = "Carb. Ring +1",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
    }

    sets.midcast.Threnody = {
        main = "Carnwenhan",
        sub = "Genmei shield",
        range = "Gjallarhorn",
        head = "Brioso roundlet +3",
        body = "Brioso Justau. +3",
        hands = "Brioso cuffs +3",
        legs = "Brioso Cannions +3",
        feet = "Brioso Slippers +3",
        neck = "Moonbow whistle +1",
        waist = "Chaac belt",
        left_ear = "Enchntr. Earring +1",
        right_ear = "Regal Earring",
        left_ring = "Kishar Ring",
        right_ring = "Carb. Ring +1",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
    }

    sets.midcast.Buff = {
        main = "Carnwenhan",
        sub = "Genmei shield",
        head = "Fili Calot +1",
        neck = "Moonbow whistle +1",
        body = "Fili Hongreline +1",
        hands = "Fili Manchettes +1",
        legs = "Inyanga Shalwar +2",
        feet = "Brioso Slippers +3"
    }

    sets.midcast.Cure = {
        main = {
            name = "Grioavolr",
            augments = {
                'Enh. Mag. eff. dur. +10',
                'Mag. Acc.+4',
                '"Mag.Atk.Bns."+18',
            }
        },
        sub = "Fulcio grip",
        head = "Vanya Hood",
        neck = "Nodens gorget",
        ear1 = "Enchanter Earring +1",
        ear2 = "Loquac. Earring",
        body = "Heka's Kalasiris",
        hands = "Kaykaus cuffs",
        ring1 = "Rahab Ring",
        ring2 = "kishar Ring",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
        waist = "Hachirin-no-obi",
        legs = "Chironic hose",
        feet = "Kaykaus boots"
    }

    sets.midcast.Marsyas = {
        range = "Marsyas",
        main = "Carnwenhan",
        sub = "Genmei shield",
        head = "Fili Calot +1",
        neck = "Moonbow whistle +1",
        body = "Fili Hongreline +1",
        hands = "Fili Manchettes +1",
        legs = "Inyanga Shalwar +2",
        waist = "Luminary sash",
        feet = "Brioso Slippers +3",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
    }

    sets.midcast.Lullaby = {
        range = "Marsyas",
        main = "Carnwenhan",
        sub = "Genmei shield",
        head = "Brioso roundlet +3",
        neck = "Moonbow whistle +1",
        body = "Fili Hongreline +1",
        hands = "Brioso cuffs +3",
        legs = "Inyanga Shalwar +2",
        feet = "Brioso Slippers +3",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
    }

    sets.midcast.DBuff = {range = "Daurdabla", ammo = empty}

    sets.midcast.GBuff = {range = "Gjallarhorn", ammo = empty}

    sets.midcast.Duration = {
        body = "Fili Hongreline +1",
        neck = "Moonbow whistle +1",
        legs = "Inyanga Shalwar +2",
        feet = "Brioso Slippers +3"
    }

    sets.midcast.Ballad = {legs = "Fili Rhingrave +1"}

    sets.midcast.Scherzo = {feet = "Fili cothurnes +1"}

    sets.midcast.Paeon = {range = "Daurdabla"}

    sets.midcast.Base = sets.midcast.Haste

    sets.midcast.Waltz = {}

    sets.midcast.Stoneskin = {
        main = "Oranyan",
        sub = "Fulcio Grip",
        neck = "Incanter's torque",
        head = "Telchine cap",
        body = "Telchine Chasuble",
        hands = "Chironic gloves",
        legs = "Telchine braconi",
        feet = "Telchine Pigaches",
        back = {
            name = "Intarabus's Cape",
            augments = {
                'CHR+20',
                'System: 1 ID: 80 Val: 19',
                'Mag. Acc.+10',
                '"Fast Cast"+10',
            }
        },
        waist = "Siegel sash",
        right_ear = "Andoaa Earring",
    }

    -- Aftercast Sets
    sets.aftercast = {}
    sets.aftercast.Regen = {
        main = "Carnwenhan",
        sub = "Genmei shield",
        range = "Marsyas",
        ammo = empty,
        head = "Aya. Zucchetto +1",
        body = "Ayanmo Corazza +1",
        hands = "Aya. Manopolas +1",
        legs = "Aya. Cosciales +1",
        feet = "Fili cothurnes +1",
        neck = "Loricate torque +1",
        waist = "Flume Belt",
        left_ear = "Mendi. Earring",
        right_ear = "Genmei Earring",
        left_ring = "Moonbeam Ring",
        right_ring = "Defending Ring",
        back = "Cheviot Cape",
    }

    sets.aftercast.PDT = {
        main = "Carnwenhan",
        sub = "Genmei shield",
        range = "Marsyas",
        ammo = empty,
        head = "Aya. Zucchetto +1",
        body = "Ayanmo Corazza +1",
        hands = "Aya. Manopolas +1",
        legs = "Aya. Cosciales +1",
        feet = "Fili cothurnes +1",
        neck = "Loricate torque +1",
        waist = "Flume Belt",
        left_ear = "Mendi. Earring",
        right_ear = "Genmei Earring",
        left_ring = "Moonbeam Ring",
        right_ring = "Defending Ring",
        back = "Cheviot Cape",
    }

    sets.aftercast.Engaged = {
        main = "Carnwenhan",
        sub = "Genmei shield",
        range = "Marsyas",
        ammo = empty,
        head = "Aya. Zucchetto +1",
        body = "Ayanmo Corazza +1",
        hands = "Aya. Manopolas +1",
        legs = "Aya. Cosciales +1",
        feet = "Fili cothurnes +1",
        neck = "Loricate torque +1",
        waist = "Flume Belt",
        left_ear = "Mendi. Earring",
        right_ear = "Genmei Earring",
        left_ring = "Moonbeam Ring",
        right_ring = "Defending Ring",
        back = "Cheviot Cape",
    }

    sets.aftercast._tab = {'Regen', 'PDT'}

    sets.aftercast._index = 1

    sets.aftercast.Idle = sets.aftercast[sets.aftercast._tab[sets.aftercast._index]]

    DaurdSongs = T{
        'Water Carol',
        'Water Carol II',
        'Ice Carol',
        'Ice Carol II',
        'Herb Pastoral',
        'Goblin Gavotte'
    }

    send_command('input /macro book 14;wait .1;input /macro set 2')
    timer_reg = {}
    pianissimo_cycle = false
end

function pretarget(spell)
    if spell.type == 'BardSong' and spell.target.type and spell.target.type == 'PLAYER' and not buffactive.pianissimo and not spell.target.charmed and not pianissimo_cycle then
        cancel_spell()
        pianissimo_cycle = true
        send_command('input /ja "Pianissimo" <me>;wait 1.5;input /ma "' .. spell.name .. '" ' .. spell.target.name .. ';')
        return
    end
    if spell.name ~= 'Pianissimo' then pianissimo_cycle = false end
end

function precast(spell)
    if spell.type == "BardSong" then
        equip(sets.precast.FC.Song)
        if buffactive["Nightingale"] then
            if spell.english == "Honor March" then
                equip(sets.midcast.Buff, sets.midcast.Marsyas)
            else
                equip_song_gear(spell)
            end
        end
    elseif spell.action_type == "Magic" then
        equip(sets.precast.FC.Normal)
    end
    if spell.action_type == "Magic" then
        if sets.precast.FC[tostring(spell.element)] then equip(sets.precast.FC[tostring(spell.element)]) end
    end
    if sets.precast.JA[spell.name] then equip(sets.precast.JA[spell.name]) end

    if spell.english == 'Mordant Rime' then
        equip(sets.MordantRime)
        send_command('@input /echo Mordant Rime Set')

    elseif spell.english == "Rudra's Storm" then
        equip(sets.Rudra)
        send_command('@input /echo Rudra Set')

    elseif spell.english == 'Evisceration' then
        equip(sets.Evisceration)
        send_command('@input /echo Evisceration Set')

    elseif spell.english == 'Exenterator' then
        equip(sets.Exen)
        send_command('@input /echo Exenterator Set')
    end
end

function midcast(spell)
    if spell.type == "BardSong" then
        if spell.english == "Honor March" then
            equip(sets.midcast.Buff, sets.midcast.Marsyas)
        else
            equip_song_gear(spell)
            if spell.name == "Ice Threnody II" then equip({waist = "Chaac belt"}) end
        end
    elseif string.find(spell.name, "Cure") or string.find(spell.name, "Curaga") then
        equip(sets.midcast.EnmityRecast, sets.midcast.Cure)
    elseif spell.name == "Cursna" then
        equip(sets.midcast.EnmityRecast, sets.midcast.Cursna)
    elseif spell.name == "Haste" then
        equip(sets.midcast.EnmityRecast, sets.midcast.Stoneskin)
    elseif spell.name == "Stoneskin" then
        equip(sets.midcast.EnmityRecast, sets.midcast.Stoneskin)
        if buffactive["Stoneskin"] then windower.send_command('wait 1;cancel 37;') end
    elseif string.find(spell.name, "Protect") or string.find(spell.name, "Shell") then
        equip(sets.midcast.EnmityRecast, sets.midcast.ProShell)
    elseif spell.name == "Sneak" and buffactive["Sneak"] and spell.target.type == "SELF" then
        windower.send_command('cancel 71;')
    elseif spell.type == "Ninjutsu" then
        if spell.name == "Utsusemi: Ichi" then
            equip(sets.aftercast.PDT)
            if buffactive["Copy Image"] then windower.send_command('wait 1;cancel 66;') end
        else
            equip(sets.aftercast.PDT)
        end
    elseif spell.action_type == "Magic" then
        equip(sets.midcast.EnmityRecast)
    end
end

function aftercast(spell)
    if midaction() then return end
    --[[    if spell.type and spell.type == 'BardSong' and spell.target and spell.target.type:upper() == 'SELF' then
        local t = os.time()
        
        -- Eliminate songs that have already expired
        local tempreg = {}
        for i,v in pairs(timer_reg) do
            if v < t then tempreg[i] = true end
        end
        for i,v in pairs(tempreg) do
            timer_reg[i] = nil
        end
        
        local dur = calculate_duration(spell.name)
        if timer_reg[spell.name] then
            if (timer_reg[spell.name] - t) <= 120 then
                send_command('timers delete "'..spell.name..'"')
                timer_reg[spell.name] = t + dur
                send_command('timers create "'..spell.name..'" '..dur..' down')
            end
        else
            local maxsongs = 2
            if player.equipment.range == 'Daurdabla' then
                maxsongs = maxsongs+2
            end
            if buffactive['Clarion Call'] then
                maxsongs = maxsongs+1
            end
            if maxsongs < table.length(timer_reg) then
                maxsongs = table.length(timer_reg)
            end
            
            if table.length(timer_reg) < maxsongs then
                timer_reg[spell.name] = t+dur
                send_command('timers create "'..spell.name..'" '..dur..' down')
            else
                local rep,repsong
                for i,v in pairs(timer_reg) do
                    if t+dur > v then
                        if not rep or rep > v then
                            rep = v
                            repsong = i
                        end
                    end
                end
                if repsong then
                    timer_reg[repsong] = nil
                    send_command('timers delete "'..repsong..'"')
                    timer_reg[spell.name] = t+dur
                    send_command('timers create "'..spell.name..'" '..dur..' down')
                end
            end
        end
    end]]
    if player.status == 'Engaged' then
        equip(sets.TP)
    else
        equip(sets.aftercast.Idle)
    end
end

function status_change(new, old)
    if new == 'Engaged' then
        equip(sets.TP)
        disable('main', 'sub', 'ammo')
    elseif T{'Idle', 'Resting'}:contains(new) then
        equip(sets.aftercast.Idle)
    end
end

function self_command(cmd)
    if cmd == 'unlock' then
        enable('main', 'sub', 'ammo')
    elseif cmd == 'midact' then
        midaction(false)
    elseif cmd == 'idle' then
        sets.aftercast._index = sets.aftercast._index % (#sets.aftercast._tab) + 1
        windower.add_to_chat(
            8,
            'Aftercast Set: ' .. sets.aftercast._tab[sets.aftercast._index]
        )
        sets.aftercast.Idle = sets.aftercast[sets.aftercast._tab[sets.aftercast._index]]
        equip(sets.aftercast.Idle)
    end
end

function equip_song_gear(spell)
    if DaurdSongs:contains(spell.english) then
        equip(sets.midcast.Base, sets.midcast.DBuff)
    else
        if spell.target.type == 'MONSTER' then
            equip(
                sets.midcast.Base,
                sets.midcast.Debuff,
                sets.midcast.GBuff
            )
            if buffactive.troubadour or buffactive['elemental seal'] then equip(sets.midcast.Duration) end
            if string.find(spell.english, 'Lullaby') then equip(sets.midcast.Duration, sets.midcast.Lullaby) end
        else
            equip(
                sets.midcast.Base,
                sets.midcast.Buff,
                sets.midcast.GBuff
            )
            if string.find(spell.english, 'Ballad') then equip(sets.midcast.Ballad) end
            if string.find(spell.english, 'Scherzo') then equip(sets.midcast.Scherzo) end
            if string.find(spell.english, 'Paeon') then equip(sets.midcast.Paeon) end
        end
    end
end

function calculate_duration(name)
    local mult, ext = 1, 0
    if player.equipment.range == 'Marsyas' then mult = mult + 1.0 end
    if player.equipment.range == "Gjallarhorn" then mult = mult + 0.4 end

    if player.equipment.neck == "Moonbow whistle +1" then mult = mult + 0.1 end
    if player.equipment.feet == "Brioso Slippers" then mult = mult + 0.1 end
    if player.equipment.body == "Aoidos' Hngrln. +2" then mult = mult + 0.1 end
    if player.equipment.legs == "Inyanga Shalwar +2" then mult = mult + 0.1 end
    if player.equipment.main == "Carnwenhan" then mult = mult + 1.0 end

    if string.find(name, 'March') and player.equipment.hands == 'Ad. Mnchtte. +2' then mult = mult + 0.1 end
    if string.find(name, 'Minuet') and player.equipment.body == "Aoidos' Hngrln. +2" then mult = mult + 0.1 end
    if string.find(name, 'Madrigal') and player.equipment.head == "Fili Calot +1" then mult = mult + 0.1 end
    if string.find(name, 'Ballad') and player.equipment.legs == "Aoidos' Rhing. +2" then mult = mult + 0.1 end
    if string.find(name, 'Scherzo') and player.equipment.feet == "Aoidos' Cothrn. +2" then mult = mult + 0.1 end
    if string.find(name, 'Paeon') and player.equipment.head == "Bihu Roundlet +1 +1" then mult = mult + 0.1 end

    if buffactive.Troubadour then mult = mult * 2 end
    if string.find(name, 'Scherzo') and buffactive['Soul Voice'] then
        mult = mult * 2
    elseif string.find(name, 'Scherzo') and buffactive.marcato then
        mult = mult * 1.5
    end

    if buffactive['Clarion Call'] then ext = 20 end

    return mult * 120 + ext
end

function reset_timers()
    for i, v in pairs(timer_reg) do send_command('timers delete "' .. i .. '"') end
    timer_reg = {}
end

windower.register_event('zone change', reset_timers)
windower.register_event('logout', reset_timers)
